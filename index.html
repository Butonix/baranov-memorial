<!DOCTYPE html>
<html>
    <head>
        <title>TODO supply a title</title>
        <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha384-tsQFqpEReu7ZLhBV2VZlAu7zcOV+rXbYlF2cqB8txI/8aZajjp4Bqd+V6D5IgvKT" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link rel="stylesheet" href="./res/css/bootstrap.min.css">
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            .memorial-card {
                width: 25rem; margin:1.25rem;
            }

            .memorial-card .date {
                float:right;
            }

            .memorial-card .logo {
                width: 50px;
                position: absolute;
                margin: 5px;
                right: 0;
            }

            #records_container {
                padding:50px;
            }

            /*.memorial-card .bottomstuff {
                bottom: 0;
                left: 0;
                position: absolute;
                margin-bottom: 1.25rem;
                margin-left: 1.25rem;
            }*/
            html {
                position: relative;
                min-height: 100%;
            }
            body {
                /* Margin bottom by footer height */
                margin-bottom: 60px;
            }
            .footer {
                position: absolute;
                bottom: 0;
                width: 100%;
                /* Set the fixed height of the footer here */
                height: 60px;
                line-height: 60px; /* Vertically center the text there */
                background-color: #303030;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="jumbotron">
                <h1 class="display-4">Мемориал Евгения Баранова</h1>
                <p class="lead">Слова</p>
                <hr class="my-4">
                <p>Расширенные слова</p>
                <a class="btn btn-primary btn-lg" href="https://dtf.ru/life/81082-zhenya-spasibo" role="button">Запись "Женя, спасибо" на DTF</a>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row" id="records_container">

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <span class="text-muted"><a href="https://github.com/nev3rfail/baranov-memorial"><img style="width:80px" src="./res/image/github.png" alt="Помоги данными"></a>Начальные материалы собраны <a href="https://github.com/nev3rfail">nev3rfail</a>. Код и данные доступны по лицензии Creative Commons. </span>
            </div>
        </footer>
        <script>

            var logos = {
                "igromania": "igromania.svg",
                "dtf": "dtf.png",
                "stopgame": "stopgame.png",
                "kanobu": "kanobu.png"
            };

            var records = [];
            var loaded_event = new CustomEvent('records.loaded', {
                bubbles: true
            });
            function compile_all() {
                var data_files = [
                    'dtf_main',
                    'igromania_main',
                    'igromania_raul',
                    'stopgame_main',
                    'stopgame_stream',
                    'kanobu'
                ];
                var needed = data_files.length;
                for (let i in data_files) {
                    $.getJSON('./data/' + data_files[i] + '.json', function (json) {
                        records = records.concat(json);
                        if (Number(i) === (needed - 1)) {
                            document.dispatchEvent(loaded_event);
                        }
                    });
                }
            }

            var base_card = `
                <div class="card memorial-card">
                    {logo}
                    {img}
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">{title}</h5>
                        <p class="card-text">{teaser_text}</p>

                        <div class="bottomstuff">{url} <span class="date">{date}</span></div>
                    </div>
                </div>`;
            var card_image = '<img src="{img}" class="card-img-top"/>';
            var card_url = '<a href="{url}" class="btn btn-primary">Перейти к материалу</a>';
            var card_logo = '<img class="logo" src="{logo}">';
            function* iterate(_records) {
                for (let i in _records) {
                    yield _records[i];
                }
            }
            document.addEventListener('records.loaded', function () {
                records = records.sort(function (a, b) {
                    let amonth;
                    let bmonth;
                    let aday;
                    let bday;
                    a = a.date;
                    b = b.date;
                    if ((a.month + "").length === 1) {
                        amonth = "0" + a.month;
                    } else {
                        amonth = a.month;
                    }
                    if ((b.month + "").length === 1) {
                        bmonth = "0" + b.month;
                    } else {
                        bmonth = b.month;
                    }
                    if ((a.day + "").length === 1) {
                        aday = "0" + a.day;
                    } else {
                        aday = a.day;
                    }
                    if ((b.day + "").length === 1) {
                        bday = "0" + b.day;
                    } else {
                        bday = b.day;
                    }
                    if (Number(a.year + "" + amonth + "" + aday) > Number(b.year + "" + bmonth + "" + bday)) {
                        return -1;
                    }
                    if (Number(a.year + "" + amonth + "" + aday) < Number(b.year + "" + bmonth + "" + bday)) {
                        return 1;
                    }
                    return 0;

                });

                let iterator = iterate(records);
                let interval = setInterval(function () {
                    let iteritem = iterator.next();
                    if (iteritem.done) {
                        clearInterval(interval);
                    } else {
                        draw_card(iteritem.value);
                    }
                }, 100);
            });

            function draw_card(record) {
                let card = base_card
                        .replace("{title}", record.title)
                        .replace("{teaser_text}", record.teaser_text)
                        .replace("{date}", record.date.year + "." + record.date.month + "." + record.date.day);
                if (record.url) {
                    card = card.replace("{url}", card_url.replace("{url}", record.url));
                } else {
                    card = card.replace("{url}", "");
                }

                if (record.img) {
                    card = card.replace("{img}", card_image.replace("{img}", record.img));
                } else {
                    card = card.replace("{img}", "");
                }

                if (logos[record.where]) {
                    card = card.replace("{logo}", card_logo.replace("{logo}", "./res/image/" + logos[record.where]));
                } else {
                    card = card.replace("{logo}", "");
                }

                $('#records_container').append(card);
            }

            compile_all();

        </script>
    </body>
</html>
